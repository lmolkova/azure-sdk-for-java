{{- include "stress-test-addons.deploy-job-template.from-pod" (list . "stress.java-eventhubs") -}}
{{- define "stress.java-eventhubs" -}}
metadata:
  labels:
    testName: "{{ .Release.Name }}"
spec:
  nodeSelector:
    sku: chaosperf
  containers:
    - name: sender
      image: {{ .Stress.imageTag }}
      imagePullPolicy: Always
      command: ['sh', '-c']
      args:
        - |
          set -a &&
          source $ENV_FILE &&
          export APPLICATIONINSIGHTS_ROLE_INSTANCE={{ .Release.Name }}-sender1 &&
          export APPLICATIONINSIGHTS_ROLE_NAME=sender-{{ .Stress.BaseName }} &&
          export TEST_CLASS={{ .Stress.senderTestClass }}
          export DURATION_MINUTES={{ .Stress.testDurationMin }}
          export SEND_MESSAGE_RATE={{ .Stress.sendRate }}
          export SEND_BATCH_SIZE={{ default 5 .Stress.sendBatchSize }}
          export SEND_CONCURRENCY={{ default 20 .Stress.sendConcurrency }}
          java -javaagent:applicationinsights-agent.jar \
          -Xms700m \
          -Dreactor.schedulers.defaultBoundedElasticSize={{ default 20 .Stress.senderConcurrency }} \
          -jar /app/azure-messaging-eventhubs-stress-1.0.0-beta.1.jar \
          --TEST_CLASS=EventSender
      {{- include "stress-test-addons.container-env" . | nindent 6 }}
      resources:
        limits:
          memory: "1G"
          cpu: "1"
    - name: receiver1
      image: {{ .Stress.imageTag }}
      imagePullPolicy: Always
      command: ['sh', '-c']
      args:
        - |
          set -a &&
          source $ENV_FILE &&
          export APPLICATIONINSIGHTS_ROLE_INSTANCE={{ .Release.Name }}-receiver1 &&
          export APPLICATIONINSIGHTS_ROLE_NAME=receiver-{{ .Stress.BaseName }} &&
          export TEST_CLASS={{ .Stress.receiverTestClass }}
          export DURATION_MINUTES={{ .Stress.testDurationMin }}
          export MAX_BATCH_SIZE={{ .Stress.processorBatchSize }}
          export MAX_WAIT_TIME_IN_MS={{ default 0 .Stress.processorMaxWaitTime }}
          export PREFETCH_COUNT={{ default 0 .Stress.prefetchCount }}
          export PROCESS_CALLBACK_DURATION_MAX_IN_MS={{ default 0 .Stress.processCallbackDurationMaxInMs }}
          java -javaagent:applicationinsights-agent.jar \
          -Dreactor.schedulers.defaultBoundedElasticSize={{ default 64 .Stress.processingConcurrency }} \
          -jar /app/azure-messaging-eventhubs-stress-1.0.0-beta.1.jar
      {{- include "stress-test-addons.container-env" . | nindent 6 }}
      resources:
        limits:
          memory: "1G"
          cpu: "0.5"
    - name: receiver2
      image: {{ .Stress.imageTag }}
      imagePullPolicy: Always
      command: ['sh', '-c']
      args:
        - |
          set -a &&
          source $ENV_FILE &&
          export APPLICATIONINSIGHTS_ROLE_INSTANCE={{ .Release.Name }}-receiver2 &&
          export APPLICATIONINSIGHTS_ROLE_NAME=receiver-{{ .Stress.BaseName }} &&
          export TEST_CLASS={{ .Stress.receiverTestClass }}
          export DURATION_MINUTES={{ .Stress.testDurationMin }}
          export MAX_BATCH_SIZE={{ .Stress.processorBatchSize }}
          export MAX_WAIT_TIME_IN_MS={{ default 0 .Stress.processorMaxWaitTime }}
          export PREFETCH_COUNT={{ default 0 .Stress.prefetchCount }}
          export PROCESS_CALLBACK_DURATION_MAX_IN_MS={{ default 0 .Stress.processCallbackDurationMaxInMs }}
          java -javaagent:applicationinsights-agent.jar \
          -Dreactor.schedulers.defaultBoundedElasticSize={{ default 64 .Stress.processingConcurrency }} \
          -jar /app/azure-messaging-eventhubs-stress-1.0.0-beta.1.jar
      {{- include "stress-test-addons.container-env" . | nindent 6 }}
      resources:
        limits:
          memory: "1G"
          cpu: "0.5"
{{- end -}}
